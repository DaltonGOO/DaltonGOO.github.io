<style>
.rvt-3d { width: 100%; height: 420px; border: 1px solid #e5e7eb; border-radius: .75rem; position: relative;
  overscroll-behavior: contain;
}
.rvt-3d .hud { position:absolute; top:.5rem; left:.5rem; background:rgba(0,0,0,.55); color:#fff; padding:.35rem .5rem; border-radius:.4rem; font:12px ui-sans-serif,system-ui }
.rvt-3d .err { position:absolute; inset:auto .5rem .5rem .5rem; background:#fff4f4; border:1px solid #fca5a5; color:#b91c1c; padding:.5rem .6rem; border-radius:.5rem; font:12px ui-sans-serif,system-ui }
.rvt-3d canvas { touch-action: none; display:block; }
</style>

<div id="p5-rvt-{{ id | default(value="a") }}" class="rvt-3d"
     data-src='{{ get_url(path=data | default(value="data/model_snapshot.json")) }}'>
  <div class="hud">Left-drag: orbit</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/p5@1.9.3/lib/p5.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/p5.easycam@1.0.1/p5.easycam.min.js"></script>

<script>
(function mount(containerId){
  const wrap = document.getElementById(containerId);
  if (!wrap) return;

  const src = wrap.getAttribute('data-src');

  const inches = x => (x || 0) * 0.0833333;
  const feet   = x => (x || 0);

  let ducts = [], equip = [];
  let sysOrder = [];
  let bounds = { min:[0,0,0], max:[0,0,0] };

  function showErr(msg){
    const e = document.createElement('div');
    e.className = 'err';
    e.textContent = msg;
    wrap.appendChild(e);
  }
  function expandBounds(x,y,z){
    bounds.min[0] = Math.min(bounds.min[0], x);
    bounds.min[1] = Math.min(bounds.min[1], y);
    bounds.min[2] = Math.min(bounds.min[2], z);
    bounds.max[0] = Math.max(bounds.max[0], x);
    bounds.max[1] = Math.max(bounds.max[1], y);
    bounds.max[2] = Math.max(bounds.max[2], z);
  }

  fetch(src, {cache:'no-store'})
    .then(r => { if(!r.ok) throw new Error(r.status+' '+r.statusText); return r.json(); })
    .then(data => {
      ducts = data.Ducts || [];
      equip = data.Equipment || [];

      const sysSet = new Set();
      ducts.forEach(d => sysSet.add(d.SystemName || 'Unknown'));
      equip.forEach(e => sysSet.add(e.System || e.SystemName || 'Unknown'));
      sysOrder = Array.from(sysSet);

      let zOffsetBySys = new Map(sysOrder.map(n => [n, 0]));
      ducts.forEach(d => {
        const sys = d.SystemName || 'Unknown';
        const len = Math.max(6, feet(d.Length_ft || 0));
        d.__sys = sys;
        d.__len = len;
        d.__zCenter = zOffsetBySys.get(sys) + len/2;
        zOffsetBySys.set(sys, d.__zCenter + len/2 + 6);
      });

      const laneSpacing = 40;
      const half = (sysOrder.length - 1) / 2;
      ducts.forEach((d) => {
        const x = (sysOrder.indexOf(d.__sys) - half) * laneSpacing;
        const y = 8;
        const z = d.__zCenter;
        const len = d.__len;
        let sx = (d.Width_in ? inches(d.Width_in) : inches(d.Diameter_in || 12));
        let sy = (d.Height_in ? inches(d.Height_in) : inches(d.Diameter_in || 12));
        if (!d.Width_in && !d.Height_in) { sx = sy = inches(d.Diameter_in || 12); }
        expandBounds(x - sx/2, y - sy/2, z - len/2);
        expandBounds(x + sx/2, y + sy/2, z + len/2);
      });
      equip.forEach((e,i) => {
        const sys = e.System || e.SystemName || 'Unknown';
        const x = (sysOrder.indexOf(sys) - half) * laneSpacing + 6;
        const y = 10, z = i * 28;
        expandBounds(x-2, y-2, z-2); expandBounds(x+2, y+2, z+2);
      });

      makeSketch();
    })
    .catch(err => showErr('3D preview failed: ' + err));

  function makeSketch(){
    new p5(p => {
      let easycam;
      const laneSpacing = 40;

      p.setup = function(){
        p.createCanvas(wrap.clientWidth, wrap.clientHeight, p.WEBGL);
        p.pixelDensity(Math.min(window.devicePixelRatio || 1, 2));
        p.noStroke();

        if (typeof p.createEasyCam === 'function') {
          easycam = p.createEasyCam({ distance: 200 });
          easycam.setZoomScale?.(0);
          easycam.setPanScale?.(0);
        } else {
          showErr('p5.EasyCam not found. Ensure p5.easycam.min.js loaded.');
        }

        const cnv = p.canvas;
        cnv.tabIndex = 0;

        const cx = (bounds.min[0] + bounds.max[0]) / 2;
        const cy = (bounds.min[1] + bounds.max[1]) / 2;
        const cz = (bounds.min[2] + bounds.max[2]) / 2;
        try {
          easycam && easycam.setCenter([cx, -cy, -cz], 0.0);
          const sx = bounds.max[0] - bounds.min[0];
          const sy = bounds.max[1] - bounds.min[1];
          const sz = bounds.max[2] - bounds.min[2];
          const maxDim = Math.max(sx, sy, sz, 100);
          easycam && easycam.setDistance(maxDim * 2.5, 0.0);
        } catch (e) {}
      };

      p.windowResized = function(){
        p.resizeCanvas(wrap.clientWidth, wrap.clientHeight);
      };

      p.draw = function(){
        p.background(247);

        p.ambientLight(110);
        p.directionalLight(255, 255, 255, 0.6, 0.8, 1);

        p.push();
        p.rotateX(Math.PI/2);
        p.stroke(210); p.strokeWeight(1); p.noFill();
        for (let i=-400; i<=400; i+=20){ p.line(-400, i, 400, i); p.line(i, -400, i, 400); }
        p.pop();
        p.noStroke();

        p.scale(1, -1, 1);

        const half = (sysOrder.length - 1) / 2;

        ducts.forEach(d => {
          const x = (sysOrder.indexOf(d.__sys) - half) * laneSpacing;
          const y = 8;
          const z = d.__zCenter;

          const isRect = (d.Shape || '').toLowerCase().startsWith('rect');
          const len = d.__len;

          p.ambientMaterial(44, 160, 44);
          p.push();
          p.translate(x, y, z);

          if (isRect) {
            const w = Math.max(0.5, inches(d.Width_in || 0));
            const h = Math.max(0.5, inches(d.Height_in || 0));
            p.box(w, h, len);
          } else {
            const dia = Math.max(0.5, inches(d.Diameter_in || 0));
            p.rotateX(Math.PI/2);
            p.cylinder(dia/2, len, 24, 1);
          }
          p.pop();
        });

        equip.forEach((e, i) => {
          const sys = e.System || e.SystemName || 'Unknown';
          const x = (sysOrder.indexOf(sys) - half) * laneSpacing + 6;
          const y = 10;
          const z = i * 28;

          p.ambientMaterial(255, 127, 14);
          p.push();
          p.translate(x, y, z);
          p.sphere(1.8, 12, 12);
          p.pop();
        });
      };
    }, wrap);
  }
})("p5-rvt-{{ id | default(value='a') }}");
</script>
